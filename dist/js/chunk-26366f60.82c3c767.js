(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-26366f60"],{"00c0":function(e,t,i){"use strict";var a=i("208e"),l=i.n(a);l.a},"208e":function(e,t,i){},"2da0":function(e,t,i){"use strict";var a=i("84e8"),l=i.n(a);l.a},"345a":function(e,t,i){"use strict";var a=i("ed91"),l=i.n(a);l.a},"428a":function(e,t,i){"use strict";i.r(t);var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",[i("one_to_m_form",{attrs:{form:e.form,field:e.field,dialog:e.dialog,set_dialog:e.set_dialog,values:e.values,upload_values:e.upload_values}}),e.dialog_multiload?[i("v-dialog",{attrs:{"max-width":"500"},model:{value:e.dialog_multiload,callback:function(t){e.dialog_multiload=t},expression:"dialog_multiload"}},[i("v-card",{staticClass:"one_to_m"},[i("v-card-title",{staticClass:"headline"},[e._v("\n            Загрузка нескольких файлов\n          ")]),i("v-card-text",{staticClass:"multiload"},[i("form",{attrs:{enctype:"multipart-form/data"}},[i("input",{attrs:{type:"file",multiple:"multiple",name:this.multiload_name}})]),i("v-btn",{attrs:{color:"primary",small:""},on:{click:function(t){return e.start_multiload()}}},[e._v("Загрузить")])],1)],1)],1)]:e._e(),e.form.id?e.make_create?[e.dialog?e._e():i("a",{staticClass:"create",attrs:{href:""},on:{click:function(t){return t.preventDefault(),e.open_new_dialog()}}},[e._v("добавить")]),e.multiload_name?[e._v("\n      | \n      "),i("a",{attrs:{href:""},on:{click:function(t){return t.preventDefault(),e.start_dialog_multiload(t)}}},[e._v(" загрузить несколько файлов")])]:e._e(),e.dialog?i("a",{attrs:{href:""},on:{click:function(t){t.preventDefault(),e.dialog=!1}}},[e._v(" скрыть")]):e._e()]:e._e():[i("p",[e._v("Данный блок можно редактировать только после создания основной карты")])],i("slide",{attrs:{values:e.values,field:e.field,form:e.form,upload_values:e.upload_values}})],2)},l=[],s=i("56d7"),r=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.values&&e.values.length?i("div",[i("v-dialog",{attrs:{"max-width":"500"},model:{value:e.del_errors_out,callback:function(t){e.del_errors_out=t},expression:"del_errors_out"}},[i("v-card",{staticClass:"one_to_m"},[i("v-card-title",{staticClass:"headline"},[e._v("\n            Ошибка\n        ")]),i("ul",{staticClass:"del_error"},e._l(e.del_errors,(function(t){return i("li",{key:t},[e._v(e._s(t))])})),0)],1)],1),"list"==e.field.view_type?[i("v-layout",[i("draggable",{attrs:{tag:"div",draggable:!!e.field.sort&&".v-card"},on:{end:e.move_end},model:{value:e.list,callback:function(t){e.list=t},expression:"list"}},e._l(e.list,(function(t,a){return i("v-card",{key:t[a],staticClass:"one_to_m"},[e._l(e.field.headers,(function(a,l){return[t[a.name]?i("div",{key:a[l]},[a.change_in_slide?[i("change_in_slide",{attrs:{refresh:e.cur_refresh,form:e.form,field:e.field,name:a.name,cur_id:t.id,values:t}})]:[i("span",{staticClass:"h"},[e._v(e._s(a.description)+":")]),"file"==a.type?[i("span",{domProps:{innerHTML:e._s(e.download_file_block(a.name,e.ch_id(t),t[a.name+"_filename"]))}}),t[a.name+"_filename"]&&!e.child_field_read_only(a.name)?i("a",{attrs:{href:""},on:{click:function(i){i.preventDefault(),e.del_file(a.name,e.ch_id(t))}}},[e._v("удалить")]):[e._v("-")]]:[e._v("\n\n                                "+e._s(e.get_value_for_slide(a,t))+"\n                            ")]]],2):e._e()]})),i("div",{staticClass:"controls"},[e.field.read_only?e._e():i("v-icon",{staticClass:"edit",attrs:{small:"",color:"primary"},on:{click:function(i){return e.open_edit_dialog(t)}}},[e._v("edit")]),e.make_delete?i("v-icon",{attrs:{small:"",color:"primary"},on:{click:function(i){return e.del(t)}}},[e._v("delete")]):e._e()],1)],2)})),1)],1)]:[i("table",{staticClass:"one_to_m"},[i("thead",[i("tr",[e._l(e.field.headers,(function(t){return i("th",{key:t.name},[e._v(e._s(t.description))])})),i("th")],2)]),i("draggable",{attrs:{tag:"tbody",draggable:!!e.field.sort&&"tr"},on:{end:e.move_end},model:{value:e.list,callback:function(t){e.list=t},expression:"list"}},e._l(e.list,(function(t){return i("tr",{key:e.ch_id(t)},[e._l(e.field.headers,(function(a){return i("td",{key:a.name},[a.change_in_slide?[i("change_in_slide",{attrs:{refresh:e.cur_refresh,form:e.form,field:e.field,name:a.name,cur_id:t.id,values:t}})]:["file"==a.type?i("span",[i("span",{domProps:{innerHTML:e._s(e.download_file_block(a.name,e.ch_id(t),t[a.name+"_filename"]))}}),t[a.name+"_filename"]&&!e.child_field_read_only(a.name)?i("a",{attrs:{href:""},on:{click:function(i){i.preventDefault(),e.del_file(a.name,e.ch_id(t))}}},[e._v("удалить")]):[e._v("-")]],2):i("span",{domProps:{innerHTML:e._s(e.get_value_for_slide(a,t))}})]],2)})),i("td",{staticClass:"tool"},[e.field.read_only?e._e():i("a",{attrs:{href:"/-"+e.ch_id(t)},on:{click:function(i){return i.preventDefault(),e.open_edit_dialog(t)}}},[i("v-icon",{staticClass:"edit",attrs:{small:"",color:"primary"}},[e._v("edit")])],1),e.make_delete?i("a",{attrs:{href:"/-"+e.ch_id(t)},on:{click:function(i){return i.preventDefault(),e.del(t)}}},[i("v-icon",{attrs:{small:"",color:"primary"}},[e._v("delete")])],1):e._e()])],2)})),0)],1)]],2):e._e()},o=[],d=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("span",[[/^(textarea|text)$/.test(e.cur_field.type)?[i("field-text",{attrs:{refresh:e.cur_refresh,field:e.cur_field,parent:e.parent_sub}})]:e._e(),/^(checkbox|switch)$/.test(e.cur_field.type)?i("field-checkbox",{attrs:{field:e.cur_field,parent:e.parent_sub}}):e._e()],e.cur_field.after_html?[e._v("\n        "+e._s(e.cur_field.after_html)+"\n    ")]:e._e(),i("div",{directives:[{name:"show",rawName:"v-show",value:e.view_saved,expression:"view_saved"}],staticClass:"saved",staticStyle:{position:"relative",top:"0px"}},[i("v-icon",{attrs:{small:"",color:"green"}},[e._v("fa fa-save")])],1),i("div",{staticClass:"errors"},e._l(e.errors,(function(t,a){return i("div",{key:"error"+a},[e._v(e._s(t))])})),0)],2)},n=[];let _=0;var f={name:"change_in_slide",props:["form","field","name","field","cur_id","values","refresh"],computed:{value_for_parent(){return"1_to_m:"+this.field.name+":"+this.name+":"+this.cur_id},id_for_saved(){return"1_to_m_"+this.field.name+"_"+this.name+"_"+this.cur_id}},created(){this.update_cur_value(),s["bus"].$on("1_to_m:change_in_slide:"+this.field.name+":"+this.name+":"+this.cur_id,e=>{e.errors&&(this.errors=e.errors),e.save_ok&&(this.errors=[],this.view_saved=!0,setTimeout(()=>{this.view_saved=!1},500))})},watch:{refresh(){this.update_cur_value()}},data:function(){return{cur_field:{value:""},errors:[],cur_refresh:0,view_saved:!1}},methods:{update_cur_value(){for(let e of this.field.fields)if(e.name==this.name){for(let t in e)this.cur_field[t]=e[t];this.cur_field.value=this.values[this.name]}this.cur_refresh++},parent_sub(e){let t=e.value;e.error||(/^(checkbox|switch)$/.test(this.type)&&(t=t?1:0),this.cur_field.value=t,_++,setTimeout(()=>{_--,0==_&&s["bus"].$emit("save_field_1_to_m",{field:this.field.name,subfield:this.name,id:this.cur_id,value:t})},400))}}},u=f,c=(i("00c0"),i("2877")),h=i("6544"),m=i.n(h),v=i("132d"),p=Object(c["a"])(u,d,n,!1,null,"419a7174",null),g=p.exports;m()(p,{VIcon:v["a"]});var y={components:{change_in_slide:g},props:["form","values","field","upload_values"],data(){return{del_errors:[],del_errors_out:!1,list:[],cur_refresh:0}},watch:{values(){this.cur_refresh++,this.list=this.values}},computed:{colors_primary(){return s["bus"].colors_primary},make_delete(){return!this.form.read_only&&this.field.make_delete&&(!this.field.read_only||this.field.make_delete)}},created(){this.list=this.values},methods:{open_edit_dialog(e){s["bus"].$emit("1_to_m_open_edit_dialog:"+this.field.name,e)},ch_id(e){return e[this.field.table_id]},move_end(){let e={},t=1;for(let i of this.list)e[this.ch_id(i)]=t++;this.$http.post(BackendBase+"/1_to_m/sort/"+this.form.config+"/"+this.field.name+"/"+this.form.id,{sort_hash:e}).then().catch(e=>{this.del_errors=[e],this.del_errors_out=!0})},get_value_for_slide(e,t){let i=e.type,a=e.name,l=t[a];if("text"==i||"textarea"==i||"wysiwyg"==i)return l;if("checkbox"==i||"switch"==i)return parseInt(l)?"да":"нет";if("select_from_table"==i||"select_values"==i){let e=this.get_field_by_name(a);return e?this.get_header_from_select(e,l):"не найдено поле "+a}},get_field_by_name(e){for(let t of this.field.fields)if(t.name==e)return t},get_header_from_select(e,t){for(let i of e.values)if(t==i.v||!parseInt(t)&&!parseInt(i.v))return i.d;return"не указано"},child_field_read_only(e){if(this.form.read_only||this.field.read_only)return!0;for(let t in this.field.fields)if("name"==t.name)return!!t.read_only;return!1},del(e){let t=e[this.field.table_id],i=BackendBase+"/1_to_m/delete/"+this.form.config+"/"+this.field.name+"/"+this.form.id+"/"+t;this.$http.get(i).then(t=>{let i=t.data;if(i.success){let t=[];for(let i of this.values)i[this.field.table_id]!=e[this.field.table_id]&&t.push(i);this.upload_values(t)}this.start_dialog_errors(i.errors)})},del_file(e,t){this.del_errors=[],this.$http.get(BackendBase+"/1_to_m/delete_file/"+this.form.config+"/"+this.field.name+"/"+e+"/"+this.form.id+"/"+t).then(i=>{let a=i.data;if(a.success){let i=[];for(let a of this.values)t==a[this.field.table_id]&&(a[e+"_filename"]=""),i.push(a);this.upload_values(i)}this.start_dialog_errors(a.errors)})},download_file_block(e,t,i){let a=BackendBase+"/1_to_m/download/"+this.form.config+"/"+this.field.name+"/"+e+"/"+this.form.id+"/"+t+"/"+i,l=this.get_field_by_name(e),s="скачать",r=0;return i?this.make_view(a)?(s="просмотреть",l.preview&&l.preview.length?`${i}:<br><a href="${a}?view=1" target="_blank"><img src="${a}?view=${l.preview}"></a><br>`:`${i}: <a href="${a}?view=1" target="_blank">посмотреть</a> `):`${i}:<br><a href="${a}?view=${r}">${s}</a> `:""},make_view(e){return/\.(jpg|png|gif|gpeg|webp)$/i.test(e)},start_dialog_errors(e){e.length&&(this.del_errors=e,this.del_errors_out=!0,setTimeout(()=>{this.del_errors=[],this.del_errors_out=!1},1500))}}},b=y,k=(i("345a"),i("b0af")),w=i("99d9"),x=i("169a"),$=i("a722"),C=Object(c["a"])(b,r,o,!1,null,"7bb6a327",null),B=C.exports;m()(C,{VCard:k["a"],VCardTitle:w["c"],VDialog:x["a"],VIcon:v["a"],VLayout:$["a"]});var V=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("v-dialog",{attrs:{justify:"center",id:"is_dialog"},model:{value:e.in_dialog,callback:function(t){e.in_dialog=t},expression:"in_dialog"}},[i("v-card",{staticClass:"one_to_m"},[i("div",{staticClass:"dialog_head"},[i("div",["insert"==e.save_action?[e._v("Создание элемента")]:e._e(),"update"==e.save_action?[e._v("Редактирование элемента")]:e._e()],2),i("div",{staticClass:"close"},[i("v-icon",{staticStyle:{"text-align":"right"},on:{click:function(t){e.in_dialog=!1}}},[e._v("mdi-close")])],1)]),e._l(e.field.fields,(function(t){return i("div",{key:t.name},[!e.edit_fields[t.name]||"text"!=t.type&&"textarea"!=t.type?"select_from_table"==t.type||"select_values"==t.type?[i("field-select",{attrs:{field:e.edit_fields[t.name],parent:e.parent_sub,refresh:e.cur_refresh}})]:"checkbox"==t.type||"switch"==t.type?[i("field-checkbox",{attrs:{field:e.edit_fields[t.name],parent:e.parent_sub,refresh:e.cur_refresh}})]:"file"==t.type?[i("form",{staticClass:"upload_file",attrs:{enctype:"multipart-form/data",id:"upload_"+t.name}},[i("input",{attrs:{type:"file"}})])]:e._e():[i("field-text",{attrs:{field:e.edit_fields[t.name],parent:e.parent_sub,refresh:e.cur_refresh}})]],2)})),e.dialog_errors.length?[i("ul",{staticClass:"dialog_erros"},e._l(e.dialog_errors,(function(t,a){return i("li",{key:"dial_err"+a},[e._v(e._s(t))])})),0)]:e._e(),e.form.read_only||e.field.read_only?e._e():i("v-btn",{attrs:{color:"primary",small:""},on:{click:function(t){return e.save(e.edit_fields,e.save_action)}}},[e._v("Сохранить")])],2)],1)},D=[],T={props:["form","dialog","field","change_one_to_m","set_dialog","values","upload_values"],data(){return{edit_fields:{},cur_refresh:0,in_dialog:!1,fields:{},save_action:"",dialog_errors:[]}},created(){this.create_edit_fields(),s["bus"].$on("1_to_m_open_edit_dialog:"+this.field.name,e=>{this.open_edit_dialog(e)}),s["bus"].$on("1_to_m_open_new_dialog:"+this.field.name,()=>{this.open_new_dialog()})},watch:{dialog(){this.in_dialog=this.dialog,this.fields=this.edit_fields},in_dialog(){this.dialog_errors=[]}},methods:{save_cur(){},change_field(e){this.fields[e.name]||(this.fields[e.name]={}),this.fields[e.name].value=e.value,this.change_one_to_m()},get_child_by_name(e,t){for(let i of e.fields)if(i.name==t)return i;return!1},parent_sub(e){let t=e.value;"checkbox"!=e.type&&"switch"!=e.type||(t=t?1:0),this.edit_fields[e.name].value=t},open_new_dialog(){if(this.create_edit_fields(),this.cur_refresh=Math.random(),this.save_action="insert",this.in_dialog=!0,this.id=void 0,this.multiload_name){let e=document.querySelector("form.upload_file");e&&e.reset()}},open_edit_dialog(e){this.cur_refresh=Math.random(),this.id=e.id;for(let t of this.field.fields)this.edit_fields[t.name]&&(this.edit_fields[t.name].value=e[t.name]);this.save_action="update",this.new_values={};this.in_dialog=!0},create_edit_fields(){for(let e of this.field.fields)if(/^(file|text|textarea|checkbox|switch|select|select_from_table|select_values)$/.test(e.type)){if("select_from_table"==e.type||"select_values"==e.type)for(let i of this.field.values)i[e.name]||(i[e.name]=""),i[e.name]=i[e.name].toString();let t={};Object.assign(t,e),"text"==e.type||"textarea"==e.type?t.value="":t.value=0,this.edit_fields[e.name]=t}},save_files(e){let t=e[this.field.table_id];for(let i of this.field.fields)if("file"==i.type){let e=new FormData,a=document.querySelector("#upload_"+i.name+" input[type=file]");a.files.length&&(e.append("attach",a.files[0]),this.$http.post(BackendBase+"/1_to_m/upload_file/"+this.form.config+"/"+this.field.name+"/"+i.name+"/"+this.form.id+"/"+t,e,{headers:{"Content-Type":"multipart/form-data"}}).then(e=>{e.data.success&&this.upload_values(e.data.values)}))}},save(e,t){let i={};for(let l of this.field.fields)if(e[l.name]){let t=e[l.name].value;i[l.name]=t}let a="";if("insert"==t)a=BackendBase+"/1_to_m/insert/"+this.form.config+"/"+this.field.name+"/"+this.form.id;else{if("update"!=t)return void console.error("not set save_action");a=BackendBase+"/1_to_m/update/"+this.form.config+"/"+this.field.name+"/"+this.form.id+"/"+this.id}this.$http.post(a,{id:this.id,values:i}).then(e=>{let t=e.data;if(t.success){this.in_dialog=!1,this.id||(this.id=t.id),this.upload_values(t.values);let e=[];e[this.field.table_id]=this.id,this.save_files(e),this.add_form=!1,i={}}else this.dialog_errors=t.errors})}}},j=T,I=(i("2da0"),i("8336")),S=Object(c["a"])(j,V,D,!1,null,"2a9af6d8",null),M=S.exports;m()(S,{VBtn:I["a"],VCard:k["a"],VDialog:x["a"],VIcon:v["a"]});var O={components:{slide:B,one_to_m_form:M},data:function(){return{id:void 0,dialog:!1,values:[],save_action:"",dialog_multiload:!1}},props:["form","field"],created(){s["bus"].$on("1_to_m:upload_values:"+this.field.name,e=>{this.upload_values(e)}),this.field.values||(this.field.values=[]),this.values=this.field.values},watch:{},computed:{multiload_name(){let e=0,t="";for(let i of this.field.fields)"file"==i.type&&(e++,t=i.name);return 1==e&&t},make_create(){return!this.form.read_only&!this.field.read_only&&!this.field.not_create},fields(){let e={};for(let t of this.field.fields)e[t.name]=t;return e}},methods:{set_dialog(e){this.dialog=e},upload_values(e){this.values=e;let t=this.field;t.values=e,s["bus"].$emit("change_field",t)},open_new_dialog(){s["bus"].$emit("1_to_m_open_new_dialog:"+this.field.name)},start_dialog_multiload(){this.dialog_multiload=!0},start_multiload(){let e=document.querySelector(".multiload input[type=file]");if(e.files.length)for(let t of e.files){let e=new FormData;e.append("attach",t),this.$http.post(BackendBase+"/1_to_m/upload_file/"+this.form.config+"/"+this.field.name+"/"+this.multiload_name+"/"+this.form.id,e,{headers:{"Content-Type":"multipart/form-data"}}).then(e=>{let t=e.data;if(t.success){if(t.values.length)for(let e of t.values)this.values.push(e);this.dialog_multiload=!1}}).catch(e=>{alert(e)})}}},name:"one_to_m"},E=O,L=(i("c333"),Object(c["a"])(E,a,l,!1,null,null,null));t["default"]=L.exports;m()(L,{VBtn:I["a"],VCard:k["a"],VCardText:w["b"],VCardTitle:w["c"],VDialog:x["a"]})},6687:function(e,t,i){},"84e8":function(e,t,i){},c333:function(e,t,i){"use strict";var a=i("6687"),l=i.n(a);l.a},ed91:function(e,t,i){}}]);
//# sourceMappingURL=chunk-26366f60.82c3c767.js.map